title: dplyr使用总结
date: 2014-10-17 21:038:30
category: 数据科学
tags: [数据科学,R,R培训]
---

本文参考dplyr文档以及网上资料完成。

# 会apply,aggregate,也会plyr，为啥还要学dplyr?

## 

+ 简单易学，通俗易懂，包教包会
+ 速度与简洁的平衡：秒杀data frames操作以及plyr
+ “链”式操作，写出清晰代码


## 

```{r,eval=F}
require(plyr)
require(dplyr)
setwd("d:/project/datascience/rtraining/")
set.seed(2014)
nobs = 1e+06
df = data.frame(group = as.factor(
  sample(1:1e+05, nobs, replace = TRUE)), 
  variable = rpois(nobs, 100))
print(object.size(df), units = "MB")
str(df)

# 计算每组的均值
#plyr
system.time(grpmean<-
              ddply(df, .(group), 
                    summarize, grpmean = mean(variable)))  #26.79s
# dplyr
system.time(grpmean2<-df %>% 
              group_by(group) %>%
              summarize(grpmean = mean(variable))) # 0.27s
```

# dplyr基本功能

## 

+ 5个词: filter, select, arrange, mutate, summarise (+group_by)
+ 通吃数据库中数据以及data tables
+ 支持各种数据表的join: inner join, left join, semi-join, anti-join 
+ Window 函数用来计算排名，offsets...
+ 对比plyr更快，更简洁，更强 (也许还有些plyr的功能没有移植过来?)

## 开始之前

先安装或者查看dplyr的版本

```{r,eval=F}
packageVersion("dplyr")
packinfo = installed.packages (fields = c ("Package", "Version"))
packinfo["dplyr",c("Package", "Version")]
install.packages("dplyr")
```

## 好戏马上开演了

加载包

```{r}
library(dplyr)
library(hflights)
#explore data
data(hflights)
head(hflights,3)
```

hflights 是2011年从休斯敦机场起飞的航班

## 创建本地数据框

tbl_df 创建一个"local data frame"，相当于一个wrapper。优势在于打印的时候显示更友好

```{r}
flights=tbl_df(hflights)
flights
```


## filter : 行过滤

+ 无需像普通data frame里面还需要写data frame变量名
+ 简单易读
  + 首参数为data frame
  + 后面接着是条件
  + 返回也是一个data frame

## 我想知道某月，某天的航班？

```{r,results='hide'}
#原始
flights[flights$Month==1 & flights$DayofMonth==1,]

#dplyr
filter(flights,Month==1,DayofMonth==1)

filter(flights,UniqueCarrier=="AA"|UniqueCarrier=="UA")
filter(flights,UniqueCarrier %in% c("AA","UA"))
```

## select: 选择列

+ 类似SQL的SELECT

查看离开，到达时间以及航班号

```{r,results='hide'}
flights[,c("DepTime","ArrTime","FlightNum")]

# dplyr
select(flights,DepTime,ArrTime,FlightNum)

# ":" 选择连续列，contains来匹配列名
select(flights,Year:DayofMonth,contains("Taxi"),contains("Delay"))
#  `starts_with`, `ends_with`,  `matches` 更精确匹配
```

## 链式操作(管道)

+ 将多行语句嵌套写入一行，并提高可读性
+ %>% (读成then)

[magrittr 包](http://cran.r-project.org/web/packages/magrittr/index.html)

Q: 所有延迟60分钟起飞的航空公司？

```{r}
filter(select(flights,UniqueCarrier,DepDelay),DepDelay>60)

flights %>%
  select(UniqueCarrier,DepDelay)%>%
  filter(DepDelay>60)
```

## 链式操作(管道)

+ 多个操作时，增加了代码的可读性
+ 自动加载magrittr包提供支持
+ 也可以在dplyr包之外使用

```{r}
x1=1:5
x2=2:6
sqrt(sum((x1-x2)^2))

(x1-x2)^2%>%sum()%>%sqrt()
```

## arrange: 排序

Q: 按照起飞延迟对所有航空公司排序？

```{r}
flights[order(flights$DepDelay),c("UniqueCarrier","DepDelay")]

flights%>%
  select(UniqueCarrier,DepDelay)%>%
  arrange(DepDelay)

flights%>%
  select(UniqueCarrier,DepDelay)%>%
  arrange(desc(DepDelay))
```

## mutate: 添加新变量

Q: 每个航班飞行速度是多少？

```{r}
#?hflights可知AirTime是分钟数，所以这里需要换算成小时
flights$Speed=flights$Distance/flights$AirTime*60
flights[,c("Distance","AirTime","Speed")]

flights%>%
  select(Distance,AirTime)%>%
  mutate(Speed=Distance/AirTime*60)

flights=flights%>%mutate(Speed=Distance/AirTime*60)
```

## summarise: 总结

+ 对数据进行分组统计
+ 首先用group_by 对数据分组
+ n(),n_distinct(vector),...

Q: 根据目的地统计平均航班延迟

```{r}
head(with(flights,tapply(ArrDelay,Dest,mean,na.rm=T)))
head(aggregate(ArrDelay~Dest,flights,mean))

flights%>%
  group_by(Dest)%>%
  summarise(avg_delay=mean(ArrDelay,na.rm=T))
```

## summarise - 2

+ summarise_each 允许对多列同时进行统计
+ mutate_each 也可以

Q: 每个航空公司的平均航班取消与转飞比例  
Q: 每个航空公司最大/最小到达/离开延迟  

```{r}
flights%>%
  group_by(UniqueCarrier)%>%
  summarise_each(funs(mean),Cancelled,Diverted)

flights%>%
  group_by(UniqueCarrier)%>%
  summarise_each(funs(min(.,na.rm=T),max(.,na.rm=T)),matches("Delay"))
```

## summarise - 3

Q: 每天总航班数目排序

+ n() 统计组中行数目
+ n_distinct(vector) 统计不同行数目

```{r}
flights %>%
  group_by(Month,DayofMonth)%>%
  summarise(flight_count=n())%>%
  arrange(desc(flight_count))

# 飞往每个目的地的总航班数与不同飞机编号(Tail Num)
flights %>%
    group_by(Dest) %>%
    summarise(flight_count = n(), plane_count = n_distinct(TailNum))
```

## tally

tally 可以一步完成上述工作，第一次使用tally进行n()操作，再来一次就是sum(n)

sort=TRUE 将对结果排序

```{r}
flights %>%
    group_by(Month, DayofMonth) %>%
    tally(sort = TRUE)
```

## 有时Grouping无需进行summarise也可以得到有意思的信息

Q: 飞往每个目的地的取消航班与未取消航班对比

```{r}
flights %>%
    group_by(Dest) %>%
    select(Cancelled) %>%
    table() %>%
    head()
```

## Join

+ inner_join ：只包含同时出现在x,y表中的行
+ left_join: 包含所有x中以及y中匹配的行
+ semi_join：包含x中，在y中有匹配的行
+ anti_join： 包含x中不匹配y的行

## 让代码来说话

```{r,echo=F,results='hide'}
x = data.frame(name = c("John", "Paul", "George", "Ringo", "Stuart", "Pete"),
instrument = c("guitar", "bass", "guitar", "drums", "bass","drums"))
y = data.frame(name = c("John", "Paul", "George", "Ringo", "Brian"),
band = c("TRUE", "TRUE", "TRUE", "TRUE", "FALSE"))
```

```{r}
x
y
```

## inner_join

```{r}
inner_join(x, y)
```

## left_join

```{r}
left_join(x, y)
```

## semi_join

```{r}
semi_join(x, y)
```

## anti_join

```{r}
anti_join(x, y)
```

## Window 函数

+ 通常我们汇总是多个输入，一个输出（均值，和...)
+ Window 函数是n个输入，返回n个值
  + ranking / ordering (min_rank,...), offset 函数 (lead / lag), cumulative aggregates ( cummean).
    
[windows function](http://cran.r-project.org/web/packages/dplyr/vignettes/window-functions.html)

## 统计每个航空公司出发延迟最长的2天

```{r}
# 出发延迟越大应该排在前面，所有用 `desc`
flights %>%
    group_by(UniqueCarrier) %>%
    select(Month, DayofMonth, DepDelay) %>%
    filter(min_rank(desc(DepDelay)) <= 2) %>%
    arrange(UniqueCarrier, desc(DepDelay))

# `top_n` 
flights %>%
    group_by(UniqueCarrier) %>%
    select(Month, DayofMonth, DepDelay) %>%
    top_n(2) %>%
    arrange(UniqueCarrier, desc(DepDelay))
```

## 每月相对上月的航班数变化

```{r}
flights %>%
    group_by(Month) %>%
    summarise(flight_count = n()) %>%
    mutate(change = flight_count - lag(flight_count))

# tally
flights %>%
    group_by(Month) %>%
    tally() %>%
    mutate(change = n - lag(n))
```

## 其它功能

抽样，查看数据结构

```{r}
# 随机选5行，不放回
flights %>% sample_n(5)

# 按比例抽样，放回
flights %>% sample_frac(0.25, replace=TRUE) 
```

```{r}
# 查看数据结构
str(flights)

glimpse(flights)
```

# 连接数据库

##

+ dplyr 可以连接数据库
+ 使用与本地数据框操作一样的语法
+ 只支持生成SELECT语句
+ 支持SQLite, PostgreSQL/Redshift, MySQL/MariaDB, BigQuery, MonetDB

[数据库](http://cran.r-project.org/web/packages/dplyr/vignettes/database.html)

## 先建立一个数据库

```{r}
setwd("d:/project/datascience/rtraining/")
my_db=src_sqlite("my_db.sqlite3",create=T)
flights_sqlite=copy_to(my_db,hflights,temporary=F,indexes=list(c("Year","Month","DayofMonth"),"UniqueCarrier","Tailnum"))
```

## 查询

```{r}
# 连接到SQLite数据库中的数据表
my_db = src_sqlite("my_db.sqlite3")

# 连接"hflights" 表
flights_tbl = tbl(my_db, "hflights")

# 查询
flights_tbl %>%
    select(UniqueCarrier, DepDelay) %>%
    arrange(desc(DepDelay))
# 显示所有数据需要先collect()
```

## SQL命令

```{r}
# 直接使用SQL命令。 sqldf包也可以干这个
tbl(my_db, sql("SELECT * FROM hflights LIMIT 100"))

# 让dplyr返回执行的 SQL commands
flights_tbl %>%
    select(UniqueCarrier, DepDelay) %>%
    arrange(desc(DepDelay)) %>%
    explain()

hflights %>%
    select(UniqueCarrier, DepDelay) %>%
    arrange(desc(DepDelay))
```

# Do

## 

[Do](http://stackoverflow.com/questions/23340150/using-dplyr-window-functions-to-make-trailing-values/23341485#23341485)
